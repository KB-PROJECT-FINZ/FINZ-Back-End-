<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.mapper.ranking.RankingMapper">

    <!-- âœ… popular_stocks: DAY (ì˜¤ëŠ˜/ì–´ì œ) -->
    <select id="selectPopularStocksCachedDay" resultType="org.scoula.domain.ranking.PopularStockDto">
        <![CDATA[
        SELECT
            ps.stock_code        AS stockCode,
            ps.stock_name        AS stockName,
            ps.transaction_count AS transactionCount,
            ps.ranking           AS ranking,
            s.image_url          AS imageUrl
        FROM popular_stocks ps
                 LEFT JOIN stocks s ON s.code = ps.stock_code
        WHERE ps.date_type = 'DAY'
          AND ps.base_date = #{baseDate}
        ORDER BY ps.ranking ASC
            LIMIT 10
        ]]>
    </select>

    <!-- âœ… popular_stocks: WEEK (íŠ¹ì • ì£¼ì°¨) -->
    <select id="selectPopularStocksCachedWeek" resultType="org.scoula.domain.ranking.PopularStockDto">
        <![CDATA[
        SELECT
            ps.stock_code        AS stockCode,
            ps.stock_name        AS stockName,
            ps.transaction_count AS transactionCount,
            ps.ranking           AS ranking,
            s.image_url          AS imageUrl
        FROM popular_stocks ps
                 LEFT JOIN stocks s ON s.code = ps.stock_code
        WHERE ps.date_type = 'WEEK'
          AND ps.base_date = #{baseDate}
        ORDER BY ps.ranking ASC
            LIMIT 10
        ]]>
    </select>

    <!-- âœ… popular_stocksì—ì„œ ìµœì‹  WEEK ê¸°ì¤€ì¼ -->
    <select id="selectLatestWeekBaseDateFromPopular" resultType="string">
        <![CDATA[
        SELECT DATE_FORMAT(MAX(base_date), '%Y-%m-%d')
        FROM popular_stocks
        WHERE date_type = 'WEEK'
        ]]>
    </select>

    <!-- âœ… ranking_by_trait_group: ìµœì‹  WEEK ê¸°ì¤€ì¼ -->
    <select id="selectLatestWeekBaseDate" resultType="string">
        <![CDATA[
        SELECT DATE_FORMAT(MAX(base_date), '%Y-%m-%d')
        FROM ranking_by_trait_group
        WHERE date_type = 'WEEK'
          AND base_date <= CURDATE()
        ]]>
    </select>

    <!-- âœ… í•´ë‹¹ WEEK ê¸°ì¤€ì¼ ì¡´ìž¬ ì—¬ë¶€ -->
    <select id="existsWeekCacheByDate" parameterType="string" resultType="int">
        <![CDATA[
        SELECT EXISTS(
            SELECT 1
            FROM ranking_by_trait_group
            WHERE date_type = 'WEEK'
              AND base_date = #{baseDate}
        )
        ]]>
    </select>

    <!-- âœ… ì£¼ê°„ ì „ì²´ ëž­í‚¹ (í‰ë©´) -->
    <select id="selectWeeklyRankingCached" resultType="org.scoula.domain.ranking.RankingByTraitGroupDto">
        <![CDATA[
        SELECT
            r.user_id                  AS userId,
            IFNULL(u.nickname,'ìµëª…')  AS nickname,
            it.group_code              AS traitGroup,     -- ì˜ë¬¸ ê·¸ë£¹ì½”ë“œ (AGGRESSIVEâ€¦)
            u.risk_type                AS originalTrait,  -- ì„¸ë¶€ì½”ë“œ (AGR/TECâ€¦)
            r.gain_rate                AS gainRate,
            r.ranking                  AS ranking,
            IFNULL(u.profile_image, 1) AS profileImage    -- í”„ë¡œí•„ ë²ˆí˜¸(1~7), ê¸°ë³¸ 1
        FROM ranking_by_trait_group r
                 JOIN `user` u            ON u.id = r.user_id
                 JOIN investment_types it ON it.risk_type = u.risk_type
        WHERE r.date_type = 'WEEK'
          AND r.base_date = #{baseDate}
        ORDER BY r.ranking ASC
            LIMIT 100
        ]]>
    </select>

    <!-- âœ… ì£¼ê°„ ì„±í–¥ë³„ ëž­í‚¹ (ê·¸ë£¹ í•„í„° í•„ìˆ˜) -->
    <select id="selectGroupedWeeklyRankingCached" resultType="org.scoula.domain.ranking.RankingByTraitGroupDto">
        <![CDATA[
        SELECT
            r.user_id                  AS userId,
            IFNULL(u.nickname,'ìµëª…')  AS nickname,
            it.group_code              AS traitGroup,     -- ì˜ë¬¸ ê·¸ë£¹ì½”ë“œ
            u.risk_type                AS originalTrait,  -- ì„¸ë¶€ì½”ë“œ
            r.gain_rate                AS gainRate,
            r.ranking                  AS ranking,
            IFNULL(u.profile_image, 1) AS profileImage    -- í”„ë¡œí•„ ë²ˆí˜¸
        FROM ranking_by_trait_group r
                 JOIN `user` u            ON u.id = r.user_id
                 JOIN investment_types it ON it.risk_type = u.risk_type
        WHERE r.date_type = 'WEEK'
          AND r.base_date = #{baseDate}
          AND it.group_code = #{traitGroup}              -- ðŸ”¥ ì—¬ê¸° í•„í„°ê°€ í•µì‹¬
        ORDER BY r.ranking ASC
            LIMIT 100
        ]]>
    </select>

    <!-- âœ… ë‚´ ëž­í‚¹ -->
    <select id="selectMyRankingCached" resultType="org.scoula.domain.ranking.MyRankingDto">
        <![CDATA[
        SELECT
            me.user_id                                AS userId,
            me.ranking                                AS ranking,
            me.gain_rate                              AS gainRate,
            ROUND(100 * (me.ranking - 1) / NULLIF(t.total_cnt, 0), 2) AS topPercent,
            it.group_code                             AS riskType,      -- ë‚´ ê·¸ë£¹(ì˜ë¬¸)
            u.risk_type                               AS originalTrait, -- ë‚´ ì„¸ë¶€ì½”ë“œ
            DATE_FORMAT(me.base_date, '%Y-%m-%d')     AS baseDate
        FROM ranking_by_trait_group me
                 JOIN `user` u            ON u.id = me.user_id
                 JOIN investment_types it ON it.risk_type = u.risk_type
                 JOIN (
            SELECT COUNT(*) AS total_cnt
            FROM ranking_by_trait_group
            WHERE date_type = 'WEEK'
              AND base_date = #{baseDate}
        ) t ON 1 = 1
        WHERE me.date_type = 'WEEK'
          AND me.base_date = #{baseDate}
          AND me.user_id = #{userId}
            LIMIT 1
        ]]>
    </select>

</mapper>
